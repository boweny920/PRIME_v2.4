#!/usr/bin/env python 

import pandas as pd 
import argparse
import sys
import os

parser = argparse.ArgumentParser()
# parser.add_argument('-s', '--sample_report', default=None, help= "Input Samplereport.csv associated to order, generated by primary analysis pipeline")
parser.add_argument('--output_dir', default="./", help="Output directory, default=cwd, default='./'")
parser.add_argument('--driver_csv', help='provide fcid')
parser.add_argument('--multiqc_bowtie2_txt', help='provide multiqc_bowtie2.txt')
# parser.add_argument('--nanalysis_path', help= "path to /n/analysis")
args=parser.parse_args()

df_driver = pd.read_csv(args.driver_csv)
df_multi_bt2 = pd.read_csv(args.multiqc_bowtie2_txt, sep="\t")

df_driver_merged = pd.merge(df_driver, df_multi_bt2, left_on='fileNames', right_on='Sample', how='inner')
df_sampleReport = df_driver_merged[["Order","OrderType","SampleName","LibraryID","IndexSequences","Read","Reference","Species","Lab","Type","ReadLength"]]
df_sampleReport["TotalReads"] = df_driver_merged["total_reads"]
df_sampleReport["AlignPercent"] = df_driver_merged["overall_alignment_rate"]
df_sampleReport["Output"] = df_driver_merged["fileNames"] + ".fastq.gz" # Changed to orginal SampleReport format to make everyone happy :D
# df_sampleReport["FastqPath"] = df_driver_merged["resultPaths"].astype(str) + "/" + df_driver_merged["fileNames"].astype(str) + ".fastq.gz"
df_sampleReport["FastqPath"] = df_driver_merged["resultPaths"].astype(str) + df_driver_merged["fileNames"].astype(str) + ".fastq.gz"

# df_sampleReport[["IndexSequence1", "IndexSequence2"]] = df_sampleReport["IndexSequences"].str.split(pat="-",expand=True)
df_sampleReport["IndexSequence1"], df_sampleReport["IndexSequence2"] = zip(*df_sampleReport["IndexSequences"].str.split("-").apply(lambda x: x + [None] if len(x) == 1 else x).tolist())
# Handling cases where no "-" is present
df_sampleReport["IndexSequence2"].fillna("NA", inplace=True)

col_order = ["Output","Order","OrderType","SampleName","LibraryID","IndexSequence1","IndexSequence2","Read","Reference","Lab","TotalReads","AlignPercent","Type","ReadLength","Species","FastqPath"]
df_sampleReport = df_sampleReport[col_order]
df_sampleReport.sort_values(by='Output', inplace=True)
df_sampleReport.to_csv("Prime_Sample_Report.csv", index=False)

for molng_id in df_sampleReport["Order"].unique():
    df_molng = df_sampleReport[df_sampleReport["Order"]==molng_id]
    nanalysis_path =df_driver_merged[df_driver_merged['Order']==molng_id]['resultPaths'].unique()
    
    if len(nanalysis_path)>1:
        sys.exit(f"more than one nanalysis_path associated to one {molng_id}")
    nanalysis_path = nanalysis_path[0]
    if os.path.exists(nanalysis_path) == False:
        os.makedirs(nanalysis_path)
    
    df_molng.to_csv(os.path.join(nanalysis_path,"Sample_Report.csv"), index=False)